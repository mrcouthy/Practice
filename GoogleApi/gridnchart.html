<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Google Visualization API Sample
    </title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <style type="text/css">
        .sub-total
        {
            font-weight: bold;
            background: #f9f9f9 !important;
            text-align: right;
        }

        .sub-total-label
        {
            font-weight: bold;
            background: #f9f9f9 !important;
            text-align: left;
        }
    </style>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script charset="utf-8" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript">
        google.load('visualization', '1', { packages: ['table', 'corechart'] });
    </script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-success">
                    <div id='Div7' class="panel-heading">Data</div>
                    <div id='Div8' class="panel-body">
                        <p><strong>
                               <a href="https://docs.google.com/spreadsheets/d/1FyEm2YS6GrBtRQUN6x9lf6ODoNDsXJJD6Rh0UG8vSAs/edit#gid=0">2 Level Grouping data from Google Docs</a>
                           </strong>
                            <button class="btn btn-info btn-xs" id="a">Load</button>
                        </p>
                        <p><strong>
                               <a href="https://docs.google.com/spreadsheets/d/1lKhpAkmqZR3FKbpFXKaWfXLus2WBpTyBxXbEFntcfIQ/edit?usp=sharing">3 Level Grouping data from Google Docs</a>
                           </strong><button class="btn btn-info btn-xs" id="b">Load</button></p>
                        <p><strong>
                               <a href="https://docs.google.com/spreadsheets/d/1qWYqqJH1UBNXzs5rRgFWJvqvpqjQRBQ8WTl-NEhIkBY/edit?usp=sharing">4 Level Grouping data from Google Docs</a>
                           </strong><button class="btn btn-info btn-xs" id="c">Load</button></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div id='Div3' class="panel-heading">Table</div>
                    <div id='columnchart' class="panel-body"></div>
                </div>
            </div>
        </div>
<!--        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div id='Div1' class="panel-heading">Table</div>
                    <div id='Div2' class="panel-body"></div>
                </div>
            </div>
        </div>-->
    </div>
    <script type="text/javascript">
        var data = {}, group = {}, groupYear = {};

        var noOfGroups = 2;
        var groupsList = [];
        var groupingFieldList = [];
        var a = 'https://docs.google.com/spreadsheets/d/1FyEm2YS6GrBtRQUN6x9lf6ODoNDsXJJD6Rh0UG8vSAs/edit#gid=0';
        var b = 'https://docs.google.com/spreadsheets/d/1lKhpAkmqZR3FKbpFXKaWfXLus2WBpTyBxXbEFntcfIQ/edit?usp=sharing';
        var c = 'https://docs.google.com/spreadsheets/d/1qWYqqJH1UBNXzs5rRgFWJvqvpqjQRBQ8WTl-NEhIkBY/edit?usp=sharing';
        var selection = a;

        function tableClassHack() {
            var className = 'google-visualization-table-table';
            $('.' + className).addClass("table table-hover table-condensed");
            $('.' + className).removeClass(className);
        };

        function visualization() {

            getData();

            $("#Div3").text("2 Level Grouping");
            $(window).resize(function () {
                if (this.resizeTO) clearTimeout(this.resizeTO);
                this.resizeTO = setTimeout(function () {
                    $(this).trigger('resizeEnd');
                }, 500);
            });

            $(window).on('resizeEnd', function () {

            });

            $("#a").click(function() {
                selection = a;
                noOfGroups = 2;
                $("#Div3").text("2 Level Grouping");
                getData();
            });

            $("#b").click(function () {
                selection = b;
                noOfGroups = 3;
                $("#Div3").text("3 Level Grouping");
                getData();
            });

            $("#c").click(function () {
                selection = c;
                noOfGroups = 4;
                $("#Div3").text("4 Level Grouping");
                getData();
            });
        };

        function getData() {
            groupsList = [];
            groupingFieldList = [];
            console.log('no of groups ' + noOfGroups);
            var query = new google.visualization.Query(selection);
            query.send(handleQueryResponse);
        };

        function handleQueryResponse(response) {
            if (response.isError()) {
                alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                return;
            }

            window.data = response.getDataTable();
            draw(window.data);
        };

        function draw(data) {
            function addEventListener(control, container, events) {
                for (var x = 0; x < events.length; x++) {
                    google.visualization.events.addListener(control, events[x],
                        function (event) {
                            //var table = $(container).find(".google-visualization-table-table");
                            //var tr = $(table).find("tr:eq(0)");
                            //$(tr).find('td').wrapInner('<div/>').find('div').unwrap().wrap('<th/>');
                            //$(table).prepend("<thead></thead>");
                            //$(table).find('thead').append(tr);
                            //$(table).find('thead >tr').find('th').addClass("text-center");
                            tableClassHack();
                        });
                }
            };

            var chart = new google.visualization.Table(document.getElementById('columnchart'));
            //var chart1 = new google.visualization.Table(document.getElementById('Div2'));

            addEventListener(chart, '#columnchart', ['ready']);
            //addEventListener(chart1, '#Div2', ['ready']);
            
            var cols = data.getNumberOfColumns();
            //aggregation columns
            var aggregations = [];

            for (var i = noOfGroups; i < cols; i++) {
                aggregations.push({ 'column': i, 'aggregation': google.visualization.data.sum, 'type': 'number' });
            }

            for (i = 0; i < noOfGroups; i++) {
                var groupingFields = [];
                for (var j = 0; j <= i; j++) {
                    groupingFields[j] = j;
                }

                groupingFieldList.push(groupingFields);
                groupsList[i] = google.visualization.data.group(data, groupingFields, aggregations);
            }

            groupsList.reverse();
            groupingFieldList.reverse();
            //console.log(groupingFieldList);

            //add subtotal rows 
            i = 0;
            for (i ; i < groupingFieldList.length ; i++) {
                var grpCols = groupsList[i].getNumberOfColumns(),
                    grpRows = groupsList[i].getNumberOfRows();
                for (j = 0; j < grpRows ; j++) {
                    var row = [];
                    var values = [], filters = [];
                    for (var k = 0; k < groupingFieldList[i].length; k++) {
                        var val = groupsList[i].getValue(j, k);
                        values[k] = val;
                        filters[k] = { column: k, value: val };

                        if (k == groupingFieldList[i].length - 1) {
                            row[k] = { v: val + " Total", p: { className: 'sub-total-label' } };
                        }

                        else {
                            row[k] = { v: '', p: { className: 'sub-total' } };
                        }
                    }

                    var hi = groupingFieldList[0].length;
                    var lo = groupingFieldList[i].length;
                    //console.log(hi + "," + lo);
                    //blank fill cells
                    for (k=lo; k < hi; k++) {
                        row[k] = { v: '', p: { className: 'sub-total' } };
                    }
                    //console.log(grpCols + "," + lo);
                    //console.log(hi + "," + cols);
                    for (k = hi; k < cols; k++) {
                        //console.log(i);
                        val = groupsList[i].getValue(j, lo++);
                        row[k] = { v: val, p: { className: 'sub-total' } };
                    }

                    var subIndices = data.getFilteredRows(filters);
                    var index = subIndices[subIndices.length - 1] +i +  1;
                    data.insertRows(index, [row]);
                }
            }

            chart.draw(data, {
                cssClassNames: {
                    headerRow: 'someclass',
                    tableRow: 'someclass',
                    oddTableRow: 'someclass',
                    selectedTableRow: 'someclass',
                    hoverTableRow: 'someclass',
                    headerCell: 'someclass',
                    tableCell: 'someclass',
                    rowNumberCell: 'someclass'
                }
            });

            //chart1.draw(groupsList[0], {
            //    page: 'enable',
            //    pageSize: 10,
            //    cssClassNames: {
            //        headerRow: 'someclass',
            //        tableRow: 'someclass',
            //        oddTableRow: 'someclass',
            //        selectedTableRow: 'someclass',
            //        hoverTableRow: 'someclass',
            //        headerCell: 'someclass',
            //        tableCell: 'someclass',
            //        rowNumberCell: 'someclass'
            //    }
            //});
        };

        google.setOnLoadCallback(visualization);
    </script>
</body>
</html>
